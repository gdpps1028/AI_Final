<!DOCTYPE html>
<html lang="zh-TW"> 
    <head>
        <meta charset="UTF-8">
        <title>手寫中文辨識</title>
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                font-family: Arial, sans-serif;
            }   
            #draw {
                border: 1px solid #000;
                touch-action: none; /* 禁止觸控事件的默認行為 */
            }
            #controls {
                margin-top: 10px;
            }
        </style> 
    </head>
    <body>
        <h2>手寫中文字辨識</h2>
        <canvas id="draw" width="280" height="280"></canvas>
        <div id="controls">
            <button id="clear">清除</button>
            <button id="predict">送出辨識</button>
        </div>
        <script>
            const canvas = document.getElementById('draw');
            const ctx = canvas.getContext('2d');
            let drawing = false;

            // init
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 10;
            ctx.lineCap = 'round';

            // start drawing
            function start(event) {
                drawing = true;
                ctx.beginPath();
                move(event);
            }
            function end() {
                drawing = false;
            }
            function move(event) {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                let x, y;
                if (event.touches) {
                    x = event.touches[0].clientX - rect.left;
                    y = event.touches[0].clientY - rect.top;
                } else {
                    x = event.clientX - rect.left;
                    y = event.clientY - rect.top;
                }
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }   

            // add event listeners
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('touchmove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseleave', end);
            canvas.addEventListener('touchend', end);

            // clear
            document.getElementById('clear').addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }); 

            // predict
            document.getElementById('predict').addEventListener('click', async () => {
                const imgData = canvas.toDataURL('image/png');
                try {
                    const res = await fetch('/predict', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({image: imgData})
                    });
                    const {label, confidence} = await res.json();
                    alert(`預測結果：${label}（信心度 ${(confidence*100).toFixed(1)}%）`);
                } catch (err) {
                    console.error(Error);
                    alert('辨識失敗，retry');
                }
            });
        </script>
    </body>
</html> 
